<!doctype html>
<html>
    <head>
        <title>Games</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f9f9f9;
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            h1 {
                color: #333;
                margin-bottom: 20px;
            }

            table {
                border-collapse: collapse;
                width: 80%;
                max-width: 800px;
                background-color: #fff;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                border-radius: 8px;
                overflow: hidden;
            }

            th,
            td {
                padding: 12px 20px;
                text-align: center;
            }

            th {
                background-color: #007bff;
                color: white;
                font-weight: bold;
            }

            tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            button {
                background-color: #28a745;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }

            button:hover {
                background-color: #218838;
            }
        </style>
    </head>
    <body>
        <button onclick="location.href='/logout'">Logout</button>
        <button onclick="location.href='/creategame'">New Game</button>

        <h1>Active Games</h1>
        <table id="activeGameTable">
            <tr>
                <th>Your Opponent</th>
                <th>Turn</th>
                <th>Time</th>
                <th>Play</th>
            </tr>
        </table>

        <br />
        <br />

        <h1>Past Games</h1>
        <table id="pastGameTable">
            <tr>
                <th>Players</th>
                <th>Winner</th>
                <th>Time</th>
                <th>View Game</th>
            </tr>
        </table>
    </body>
    <script>
        const userId = {{.userId}}

        let dataTable = []

        var activeGameTable = document.getElementById("activeGameTable");
        var pastGameTable = document.getElementById("pastGameTable");

        connectWebSocket(userId);

        function connectWebSocket(userId) {
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            socket = new WebSocket(`${protocol}${location.host}/ws`);

            socket.onopen = () => {
                console.log("WebSocket connection opened.");
                const message = {
                    userId: userId,
                    gameId: 0,
                    action: 0,
                };
                socket.send(JSON.stringify(message));
            };

            socket.onmessage = (event) => {
                newData = JSON.parse(event.data);
                console.log(newData)
                updateDataTable(newData)
                renderTable();
            };

            socket.onerror = (err) => {
                console.error("WebSocket error", err);
            };

            socket.onclose = () => {
                console.log("WebSocket connection closed.");
            };
        }


        function handleAction(url) {
            fetch(url)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Request failed");
                    }
                    // Refresh the page after the request completes
                    location.reload();
                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }


        function sendAction(action, gameid) {
            if (socket && socket.readyState === WebSocket.OPEN) {
              const message = {
                  userId: userId,
                  gameId: gameid,
                  action: action,
              };
              socket.send(JSON.stringify(message));
            } else {
                messageDiv.textContent = "WebSocket not connected.";
            }
        }

        function updateDataTable(newData){

          newData = Array.isArray(newData) ? newData : [newData];

          for (const newItem of newData){
            const index = dataTable.findIndex(item => item.gameId === newItem.gameId);
            if (index !== -1) {
              dataTable[index] = newItem; // Replace existing object
            } else {
              dataTable.push(newItem); // Add new game
            }
            dataTable.sort((a, b) => a.gameId + b.gameId);
          }
        }


        function renderTable(){
          document.querySelectorAll("#gameData").forEach(el => el.remove());


          for (const item of dataTable) {
              row = document.createElement("tr");
              row.id = "gameData"

            // Check if it is a current or past game
            if(item.win || item.status == "DENYED"){
              table = pastGameTable;

              if (item.status == "DENYED"){
                if (item.ownerId == userId){
                  row.innerHTML = `
                      <td>${item.ownerName}</td>
                      <td>Game Ended</td>
                      <td>${item.time}</td>
                      <td>
                          <button onclick="sendAction(3, ${item.gameId})">Delete</button>
                      </td>`;
                } else{
                  row.innerHTML = `
                    <td>${item.ownerName}</td>
                    <td>Declined</td>
                    <td>${item.time}</td>
                    <td>Game Ended</td>
                  `;
                }
              } else {
                if ((item.winner == item.ownerShape) === (item.ownerId == userId)){
                  winnerName = "You"
                } else {
                  if (item.winner == item.ownerShape){
                    winnerName = item.ownerName
                  }else{
                    winnerName = item.opponentName
                  }
                }


                row.innerHTML = `
                  <td>${item.ownerName}, ${item.opponentName}</td>
                  <td>${winnerName}</td>
                  <td>${item.time}</td>
                  <td><button onclick="location.href='/game/${item.gameId}'">View Game</button></td>
                `;
              }

            } else {
              table = activeGameTable;

              if (item.currentTurn == userId){
                turn = "Your Turn"
              } else{
                turn = "Opponents Turn"
              }

              if (item.ownerId == userId){
                activeopponentname = item.opponentName
              }else{
                activeopponentname = item.ownerName
              }


              row.innerHTML = `
                  <td>${activeopponentname}</td>
                  <td>${turn}</td>
                  <td>${item.time}</td>
              `;

              if (item.status == "PENDING"){
                if (item.opponentId == userId){
                  row.innerHTML += `
                    </td>
                      <button onclick="sendAction(1, ${item.gameId})">
                          Accept
                      </button>
                      <button onclick="sendAction(2, ${item.gameId})">
                          Reject
                      </button>
                    </td>`
                } else{
                  row.innerHTML += `
                    </td>
                      <button>
                        Pending ...
                      </button>
                    </td>`
                }
              } else if (item.status == "DENYED"){
                row.innerHTML += `
                  </td>
                    <button onclick="sendAction(3, ${item.gameId})">
                      Delete
                    </button>
                  </td>`
              } else if (item.status == "ACCEPTED"){
                row.innerHTML += `
                  </td>
                    <button onclick="location.href='/game/${item.gameId}'">
                        Play
                    </button>
                  </td>`
              }
            }

            if (item.status != "DELETED"){
              table.appendChild(row);
            }
          }
        }
    </script>
</html>
